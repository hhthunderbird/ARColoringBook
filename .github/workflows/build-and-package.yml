      
      - name: Create Plugin Meta File
        run: |
          if [ -d "Assets/Plugins/iOS/${IOS_LIBRARY_NAME}.xcframework" ]; then
            cat > Assets/Plugins/iOS/${IOS_LIBRARY_NAME}.xcframework.meta << EOF
          fileFormatVersion: 2
          guid: $(uuidgen | tr '[:upper:]' '[:lower:]' | tr -d '-')
          PluginImporter:
            externalObjects: {}
            serializedVersion: 2
            iconMap: {}
            executionOrder: {}
            defineConstraints: []
            isPreloaded: 0
            isOverridable: 0
            isExplicitlyReferenced: 0
            validateReferences: 1
            platformData:
            - first:
                Any: 
              second:
                enabled: 0
                settings: {}
            - first:
                Editor: Editor
              second:
                enabled: 0
                settings:
                  DefaultValueInitialized: true
            - first:
                iPhone: iOS
              second:
                enabled: 1
                settings: {}
            userData: 
            assetBundleName: 
            assetBundleVariant: 
          EOF
            echo "? Created xcframework .meta file"
          fi
      
      - name: Upload iOS Library
        uses: actions/upload-artifact@v4
        with:
          name: ios-library
          path: Assets/Plugins/iOS/
          retention-days: 7
      
      - name: Commit iOS Library (if on main)
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          git add Assets/Plugins/iOS/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update iOS native library [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
            echo "? Committed iOS library"
          fi

  build-macos-library:
    name: Build macOS Native Library
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install CMake
        run: |
          brew install cmake ninja
      
      - name: Build macOS Library
        run: |
          cd FelinaLibrary
          mkdir -p build/macOS
          cd build/macOS
          
          cmake ../.. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../install/macOS
          
          ninja
          ninja install
          
          echo "? macOS library built successfully"
      
      - name: Copy to Unity Plugins
        run: |
          mkdir -p Assets/Plugins/macOS
          cp FelinaLibrary/install/macOS/lib/libFelina.dylib Assets/Plugins/macOS/
          echo "? Copied libFelina.dylib to Assets/Plugins/macOS/"
      
      - name: Create Plugin Meta File
        run: |
          cat > Assets/Plugins/macOS/libFelina.dylib.meta << EOF
          fileFormatVersion: 2
          guid: $(uuidgen | tr '[:upper:]' '[:lower:]' | tr -d '-')
          PluginImporter:
            externalObjects: {}
            serializedVersion: 2
            iconMap: {}
            executionOrder: {}
            defineConstraints: []
            isPreloaded: 0
            isOverridable: 1
            isExplicitlyReferenced: 0
            validateReferences: 1
            platformData:
            - first:
                Any: 
              second:
                enabled: 0
                settings: {}
            - first:
                Editor: Editor
              second:
                enabled: 0
                settings:
                  CPU: x86_64
                  DefaultValueInitialized: true
                  OS: OSX
            - first:
                Standalone: OSXUniversal
              second:
                enabled: 1
                settings:
                  CPU: x86_64
            userData: 
            assetBundleName: 
            assetBundleVariant: 
          EOF
          echo "? Created .meta file"
      
      - name: Upload macOS Library
        uses: actions/upload-artifact@v4
        with:
          name: macos-library
          path: Assets/Plugins/macOS/
          retention-days: 7

  build-unity-ios:
    name: Build Unity iOS App
    needs: [build-ios-library]
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Download iOS Library
        uses: actions/download-artifact@v4
        with:
          name: ios-library
          path: Assets/Plugins/iOS/
      
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-iOS-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-iOS-
            Library-
      
      - name: Build iOS Xcode Project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: iOS
          versioning: None
      
      - name: Upload iOS Xcode Project
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcode-project
          path: build/iOS/
          retention-days: 30

  build-unity-android:
    name: Build Unity Android App
    runs-on: ubuntu-latest
    
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-Android-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Android-
            Library-
      
      - name: Build Android APK
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
          versioning: None
      
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/Android/*.apk
          retention-days: 30

